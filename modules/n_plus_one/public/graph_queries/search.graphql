query search($company_id: String, $point: GeometryJSON, $distance: Int, $specialties: [String!]) {
  locations: customizations(name: "modules/n_plus_one/company", aggregations: {name: "geo", fields: [{name: "location", field_name: "properties.state", aggregations: [{name: "centric", type: terms, field_name: "properties.city"}]}]}) {
    aggs: aggregations {
      raw
    }
  }
  specialties: customizations(name: "modules/n_plus_one/programmer", aggregations: [{name: "spec", fields: [{name: "spec", field_name: "properties.specialties"}]}]) {
    aggs: aggregations {
      raw
    }
  }
  companies: models(
    filter: {
      models: {
        join: { join_on_property: "id" foreign_property: "company_id" }
        filter: {
          name: {value: "modules/n_plus_one/programmer"},
          properties: [
            { name: "specialties", value_in: $specialties }
          ]
        }
      }

      properties: [
        {name: "company_id", value: $company_id}
        {name: "location", distance_sphere: { center: $point distance_in_km: $distance } }
      ]
      deleted_at: { exists: false }
      name: { value_in: "modules/n_plus_one/company" }
    }
    per_page: 100
  ) {
    total_entries
    results {
      id
      name: property(name: "name")
      properties

      programmers: models(join_on_property: "id" foreign_property: "company_id" model_name: "modules/n_plus_one/programmer") {
        email: property(name: "email")
        properties
      }
    }
  }
}
